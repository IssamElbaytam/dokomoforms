{% extends "base.html" %} 


{% block header %}
<div class="header">
    {% if current_user %}
    <div class="container">
        <div class="row">
            <div class="col-md-6"><h1>Account Dashboard</h1></div>
            <div class="col-md-6 header-controls"><button class="btn btn-primary btn-sm pull-right"><span class="glyphicon glyphicon-plus"></span>&nbsp;&nbsp;Create New Survey</button></div>
        </div>
    </div>
    {% else %}
    <div class="hero">
    </div>
    {% end %}
</div>
{% end %} 

{% block content %}
<div class="content">
    <div class="container" role="main">
        <div class="message"></div>
        {% if current_user %}
        <div class="row">
            <div class="col-md-6">
                <!-- Recent Submissions -->
                <h4>Recent Submissions</h4>
                <div class="recent-submissions">
                    
                </div>
            </div>
            <div class="col-md-6">
                <!-- Activity Graph -->
                <h4>Activity Graph</h4>
                <div class="activity-graph">
                    
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <h4>Surveys</h4>
                <table id="surveys" class="table-view display table table-striped table-bordered" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th># of Submissions</th>
                            <th>Latest Submission</th>
                            <th>Activity</th>
                            <th></th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
        <!-- <div class="welcome_box content-padded">
            <h3 class="welcome_title">Welcome: {{ current_user }}</h3>
            <p class="welcome_blurb">Dive in, choose an option below.</p>
        </div>
        <div class="welcome_buttons content-padded">
            <a data-ignore="push" class="btn btn-block" href="view" id="">View</a>
            <a data-ignore="push" class="btn btn-block" href="#" id="">Create</a>
            <a data-ignore="push" class="btn btn-block" href="#" id="logout">Logout</a>
        </div> -->
        {% else %}
        <div class="welcome_box content-padded">
            <h3 data-ignore="push" class="welcome_title"> Welcome to Dokomoforms</h3>
            <p data-ignore="push" class="welcome_blurb"> Simple, offline-capable surveys.</p>
            <p data-ignore="push" class="welcome_blurb"> Sign up or login to create and view forms.</p>
        </div>
        <div class="welcome_buttons content-padded">
            <a data-ignore="push" class="btn btn-block" href="#" id="login">Login or Register</a>
        </div>
        {% end %}
    </div>
</div>

<script type="text/template" id="view-data-btn-tpl">
    <a class="btn btn-default btn-xs" href="/view/data/<%= survey_id %>"><span class="glyphicon glyphicon-stats"></span> View Data</a>
</script>

<script type="text/template" id="download-data-btn-tpl">
    <div class="btn-group">
        <button class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
            <span class="glyphicon glyphicon-cloud-download"></span> Download Data <span class="caret"></span>
        </button>
        <ul class="dropdown-menu dropdown-menu-right" role="menu">
            <li><a href="#" data-id="<%= survey_id %>">CSV (.csv)</a></li>
            <li><a href="#" data-id="<%= survey_id %>">KML (.kml)</a></li>
            <li><a href="#" data-id="<%= survey_id %>">JSON (.json)</a></li>
        </ul>
    </div>
</script>

<script type="text/template" id="manage-btn-tpl">
    <a class="btn btn-secondary btn-xs" href="/view/<%= survey_id %>" data-id="<%= survey_id %>">Manage Survey</a>
</script>

<script src="/static/lib.js"></script>

<!-- Highcharts -->
<script src="http://code.highcharts.com/highcharts.js"></script>
<script type="text/javascript">
    
    $(function () { 
        $('.activity-graph').highcharts({
            chart: {
                type: 'line'
            },
            title: {
                text: null
            },
            colors: [
                '#666'
            ],
            xAxis: {
                categories: ['Mar 12', 'Mar 19', 'Mar 26', 'Apr 2']
            },
            yAxis: {
                title: {
                    text: '# of submissions'
                }
            },
            series: [{
                name: 'Submissions',
                data: [34, 76, 58, 122]
                // data: [[Date('03-12-2015'), 34], [Date('03-19-2015'), 76], [Date('03-26-2015'),58], [Date('04-02-2015'), 122]]
            }],
            credits: {
                enabled: false
            }
        });
    });

</script>

<!-- DataTables -->
<script src="http://cdn.datatables.net/1.10.5/js/jquery.dataTables.min.js"></script>
<script src="http://cdn.datatables.net/plug-ins/1.10.6/integration/bootstrap/3/dataTables.bootstrap.js"></script>
<script>
$(document).ready(function() {
    var $surveys = $('#surveys'),
        view_btn_tpl = _.template($("#view-data-btn-tpl").html()),
        manage_btn_tpl = _.template($("#manage-btn-tpl").html()),
        dl_btn_tpl = _.template($("#download-data-btn-tpl").html());

    if ($surveys.length > 0) {
        $('#surveys').dataTable({
            language: {
                search: "Search by survey title:"
            },
            "lengthMenu": [
                [20, 50, 100],
                [20, 50, 100]
            ],
            "pagingType": "full_numbers",
            "order": [
                [2, 'desc']
            ],
            "columnDefs": [
                {
                    "data": 0,
                    "render": function(data, type, row) {
                        console.log(data);
                        return data;
                    },
                    "targets": 0
                },
                {
                    "data": 1,
                    targets: 1,
                    width: "14%"
                },
                {
                    "data": 2,
                    "render": function(data, type, row) {
                        if (data) {
                            var datetime = new Date(data);
                            return datetime.toDateString() + ' at ' + datetime.toTimeString();
                        } else {
                            return '';
                        }
                    },
                    "targets": 2
                }
                , {
                    "data": 3,
                    "render": function(data, type, row) {
                        return "...";
                    },
                    "targets": 3,
                    "sortable": false
                }
                , {
                    "data": 3,
                    "render": function(data, type, row) {
                        console.log(data);
                        var view = view_btn_tpl({survey_id: data}),
                            dl = dl_btn_tpl({survey_id: data}),
                            manage = manage_btn_tpl({survey_id: data});

                        return view + "&nbsp;" + dl + "&nbsp;" + manage;
                    },
                    "targets": 4,
                    "width": '330px',
                    "class": "text-center",
                    "sortable": false
                }
            ],
            "columns": [{
                 "name": "survey_title"
            }, {
                 "name": "num_submissions"
            }, {
                 "name": "latest_submission"
            }, {
                 "name": "survey_id"
            }],
            "processing": true,
            "serverSide": true,
            "ajax": {
                 "url": "/api/index_survey_data_table",
                 "data": function(d) {
                     return {
                         "args": JSON.stringify(d)
                     };
                 }
            }
        });
    }
});
</script>

<!-- Persona -->
<script src="https://login.persona.org/include.js"></script>
<script src="/static/persona.js"></script>

<!-- Dokomo -->
<script src="/static/app.js"></script>

{% if message %}
    <script>
        App.message("{{ message }}");
    </script>
{% end %} 

{% end %}
